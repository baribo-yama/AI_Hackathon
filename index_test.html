<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‹ãƒãƒ£ãƒ¬</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 95%;
            max-width: 550px;
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¹…ã«å«ã‚ã‚‹ */
        }

        h1, h2 {
            color: #4CAF50; /* Green */
            margin-bottom: 20px;
            font-weight: 700;
        }

        .user-info, .ranking-area {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #fcfcfc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        input[type="text"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-right: 10px;
            width: calc(100% - 120px);
            max-width: 250px;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .challenge-area {
            background-color: #ffe0b2; /* Light Orange */
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 3px solid #ff9800; /* Orange border */
            animation: fadeInScale 0.6s ease-out forwards; /* Appearance animation */
            display: none; /* Initially hidden */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .challenge-area.active {
            display: block; /* Show when active */
        }

        .challenge-area h2 {
            color: #d84315; /* Darker Orange */
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .challenge-area p {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            line-height: 1.5;
        }

        #completeChallengeBtn {
            background-color: #2196F3; /* Blue */
        }

        #completeChallengeBtn:hover {
            background-color: #1976D2;
        }

        #currentPoints {
            font-weight: 700;
            color: #4CAF50;
            font-size: 1.4em;
        }

        #displayUserId {
            font-weight: 600;
            color: #607D8B; /* Greyish Blue */
            word-break: break-all; /* é•·ã„IDã§ã‚‚æŠ˜ã‚Šè¿”ã™ */
        }

        .ranking-area ul {
            list-style: none;
            padding: 0;
            max-height: 250px; /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆã®é«˜ã•åˆ¶é™ */
            overflow-y: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fff;
        }

        .ranking-area li {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-area li:last-child {
            border-bottom: none;
        }

        .ranking-area li span:first-child {
            font-weight: 600;
        }

        /* Message Box Styles (for general messages) */
        .message-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.active {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 90%;
            min-width: 300px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .message-box.active .message-box-content {
            transform: translateY(0);
        }

        .message-box-content p {
            margin-bottom: 25px;
            font-size: 1.2em;
            font-weight: 500;
            color: #444;
        }

        .message-box-content button {
            background-color: #607D8B; /* Greyish Blue */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-box-content button:hover {
            background-color: #546E7A;
        }

        /* Comment Box Specific Styles */
        #commentMessageBox .message-box-content {
            background-color: #e3f2fd; /* Light Blue background for comment modal */
            border: 2px solid #90caf9;
        }
        #commentMessageBox p {
            color: #1a237e; /* Darker blue text */
        }
        #commentInput {
            border: 1px solid #a7d9f7;
            background-color: #f7fcff;
            color: #333;
        }
        #postCommentBtn {
            background-color: #42a5f5; /* Blue */
        }
        #postCommentBtn:hover {
            background-color: #2196F3;
        }
        #skipCommentBtn {
            background-color: #9e9e9e; /* Grey */
        }
        #skipCommentBtn:hover {
            background-color: #757575;
        }


        /* Animations */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            input[type="text"] {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            button {
                width: 100%;
            }
            .user-info button {
                margin-top: 10px;
            }
            .message-box-content {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’ª ç­‹ãƒãƒ£ãƒ¬ ğŸ’ª</h1>
        <div class="user-info">
            <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ› (10æ–‡å­—ã¾ã§)" maxlength="10" class="w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
            <button id="saveNicknameBtn" class="mt-2 md:mt-0 px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-all shadow-md">ç™»éŒ²</button>
            <p class="mt-4 text-lg">ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="displayUserId" class="font-bold text-gray-700">æœªç™»éŒ²</span></p>
            <p class="mt-2 text-xl">ç¾åœ¨ã®ç­‹è‚‰ãƒã‚¤ãƒ³ãƒˆ: <span id="currentPoints" class="font-bold text-green-600">0</span>pt</p>
        </div>

        <div id="challengeArea" class="challenge-area">
            <h2>ğŸš¨ ç­‹ãƒˆãƒ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ ğŸš¨</h2>
            <p id="challengeText" class="text-gray-800"></p>
            <button id="completeChallengeBtn" class="mt-4 px-8 py-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-all shadow-lg">ã‚„ã£ãŸï¼ (ç­‹è‚‰ãƒã‚¤ãƒ³ãƒˆGET)</button>
        </div>

        <div class="ranking-area">
            <h2>ğŸ† ç­‹è‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</h2>
            <ul id="rankingList" class="divide-y divide-gray-200">
                <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </ul>
        </div>
    </div>

    <!-- General Message Box HTML -->
    <div id="messageBox" class="message-box">
        <div class="message-box-content">
            <p id="messageText"></p>
            <button id="messageBoxCloseBtn">OK</button>
        </div>
    </div>

    <!-- Comment Box HTML -->
    <div id="commentMessageBox" class="message-box">
        <div class="message-box-content">
            <p class="text-xl font-semibold mb-4">ä»Šæ—¥ã®ç­‹ãƒˆãƒ¬ã€ã©ã†ã ã£ãŸï¼Ÿ</p>
            <textarea id="commentInput" class="w-full p-3 border rounded-lg mb-4 resize-y focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all" rows="3" placeholder="ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ› (ä»»æ„)"></textarea>
            <div class="flex justify-around gap-4">
                <button id="postCommentBtn" class="flex-1 px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-all shadow-md">æŠ•ç¨¿</button>
                <button id="skipCommentBtn" class="flex-1 px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all shadow-md">ã‚¹ã‚­ãƒƒãƒ—</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰Firebaseã®è¨­å®šã‚’å–å¾—
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db, userId; // Firebase Auth, Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹, ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        let currentPoints = 0; // ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ
        let challengeTimeout; // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¿ã‚¤ãƒãƒ¼ã®ID

        // DOMè¦ç´ ã®å–å¾—
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNicknameBtn = document.getElementById('saveNicknameBtn');
        const currentPointsSpan = document.getElementById('currentPoints');
        const displayUserIdSpan = document.getElementById('displayUserId');
        const challengeArea = document.getElementById('challengeArea');
        const challengeText = document.getElementById('challengeText');
        const completeChallengeBtn = document.getElementById('completeChallengeBtn');
        const rankingList = document.getElementById('rankingList');

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹è¦ç´  (æ±ç”¨)
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹è¦ç´ 
        const commentMessageBox = document.getElementById('commentMessageBox');
        const commentInput = document.getElementById('commentInput');
        const postCommentBtn = document.getElementById('postCommentBtn');
        const skipCommentBtn = document.getElementById('skipCommentBtn');

        // ç­‹ãƒˆãƒ¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒªã‚¹ãƒˆ
        const workoutMenus = [
            { text: "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ5å›ï¼ç«‹ã£ãŸã¤ã„ã§ã«ã‚„ã£ã¦ã¿ã‚ˆã†ï¼", points: 10 },
            { text: "èƒŒä¼¸ã³10ç§’ï¼å¤©äº•ã«æ‰‹ãŒå±Šãã‹ãªï¼Ÿ", points: 5 },
            { text: "è‚©å›ã—10å›ï¼è‚©ã“ã‚Šè§£æ¶ˆã«ã‚‚ãªã‚‹ã‚ˆï¼", points: 5 },
            { text: "æ¤…å­ã«åº§ã£ã¦è¶³è¸ã¿30ç§’ï¼æ°—åˆ†è»¢æ›ã«ï¼", points: 7 },
            { text: "è…•ç«‹ã¦ä¼ã›3å›ï¼ã§ãã‚‹ç¯„å›²ã§OKï¼", points: 15 },
            { text: "ãã®å ´ã§è¶³è¸ã¿1åˆ†ï¼è¡€è¡Œä¿ƒé€²ï¼", points: 8 },
            { text: "ã‹ã‹ã¨ä¸Šã’10å›ï¼ãµãã‚‰ã¯ãã‚’é›ãˆã‚ˆã†ï¼", points: 6 },
            { text: "å£ã‚’ä½¿ã£ãŸè…•ç«‹ã¦ä¼ã›5å›ï¼", points: 12 }
        ];

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {function} [onCloseCallback] - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ãŒé–‰ã˜ã‚‰ã‚ŒãŸå¾Œã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
         */
        const showMessageBox = (message, onCloseCallback = null) => {
            messageText.textContent = message;
            messageBox.classList.add('active');

            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
            const closeHandler = () => {
                messageBox.classList.remove('active');
                messageBoxCloseBtn.removeEventListener('click', closeHandler); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };
            messageBoxCloseBtn.addEventListener('click', closeHandler);
        };

        /**
         * ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        const showCommentMessageBox = () => {
            commentInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            commentMessageBox.classList.add('active');
        };

        /**
         * ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
         */
        const hideCommentMessageBox = () => {
            commentMessageBox.classList.remove('active');
        };

        // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        postCommentBtn.addEventListener('click', async () => {
            const comment = commentInput.value.trim();
            await saveComment(comment);
            hideCommentMessageBox();
            showMessageBox("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼", startChallengeTimer);
        });

        // ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        skipCommentBtn.addEventListener('click', async () => {
            await saveComment(""); // ç©ºã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ã‚’ç¤ºã™ï¼‰
            hideCommentMessageBox();
            showMessageBox("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚", startChallengeTimer);
        });

        /**
         * ã‚³ãƒ¡ãƒ³ãƒˆã‚’Firestoreã«ä¿å­˜ã™ã‚‹é–¢æ•°
         * @param {string} comment - ä¿å­˜ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ
         */
        const saveComment = async (comment) => {
            if (!userId) {
                console.error("User ID is not set. Cannot save comment.");
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            try {
                await updateDoc(userDocRef, {
                    lastComment: comment,
                    lastCommentTime: serverTimestamp() // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ™‚åˆ»ã‚‚è¨˜éŒ²
                });
                console.log("Comment saved successfully.");
            } catch (error) {
                console.error("Error saving comment:", error);
                showMessageBox("ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ¡ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        };

        /**
         * Firebaseã‚’åˆæœŸåŒ–ã—ã€èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹é–¢æ•°
         */
        const initializeFirebaseAndAuth = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼æ¸ˆã¿ã®å ´åˆ
                        userId = user.uid;
                        displayUserIdSpan.textContent = userId; // UIã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤º
                        console.log("Firebase Auth Ready. User ID:", userId);
                        await loadUserData(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
                        updateRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœªèªè¨¼ã®å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ãªã‘ã‚Œã°åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³
                        console.log("User is signed out or anonymous. Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (signInError) {
                            console.error("Error during sign-in:", signInError);
                            showMessageBox("ã‚¨ãƒ©ãƒ¼: èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                            // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (èªè¨¼ãŒå®Œå…¨ã«å¤±æ•—ã—ãŸå ´åˆ)
                            userId = localStorage.getItem('userId') || crypto.randomUUID();
                            displayUserIdSpan.textContent = userId + " (åŒ¿å)";
                            await loadUserData();
                            updateRanking();
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("ã‚¨ãƒ©ãƒ¼: ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        };

        /**
         * ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¿å­˜ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
         */
        saveNicknameBtn.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('nickname', nickname);
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ã“ã“ã§è¨­å®šï¼ˆåŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆï¼‰
                if (!userId) {
                    userId = localStorage.getItem('userId') || crypto.randomUUID();
                    localStorage.setItem('userId', userId);
                    displayUserIdSpan.textContent = userId + " (åŒ¿å)";
                }
                await loadUserData(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
                startChallengeTimer(); // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                showMessageBox(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€Œ${nickname}ã€ã§ç™»éŒ²ã—ã¾ã—ãŸï¼`);
            } else {
                showMessageBox('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ã€UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        const loadUserData = async () => {
            if (!userId) {
                console.warn("User ID is not set yet. Cannot load user data.");
                return;
            }

            const nickname = localStorage.getItem('nickname');
            if (nickname) {
                nicknameInput.value = nickname;
                saveNicknameBtn.disabled = true; // ç™»éŒ²æ¸ˆã¿ãªã‚‰ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
                nicknameInput.disabled = true; // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›æ¬„ã‚‚ç„¡åŠ¹åŒ–
            } else {
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãªã‘ã‚Œã°ã€å…¥åŠ›å¯èƒ½ã«ã™ã‚‹
                saveNicknameBtn.disabled = false;
                nicknameInput.disabled = false;
            }

            // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                currentPoints = userDoc.data().points || 0;
                currentPointsSpan.textContent = currentPoints;
                // Firestoreã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å„ªå…ˆï¼ˆåˆ¥ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ›´æ–°è€ƒæ…®ï¼‰
                if (userDoc.data().nickname && userDoc.data().nickname !== nickname) {
                    nicknameInput.value = userDoc.data().nickname;
                    localStorage.setItem('nickname', userDoc.data().nickname);
                }
            } else {
                // åˆã‚ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°Firestoreã«ç™»éŒ²
                await setDoc(userDocRef, {
                    nickname: nickname || 'åç„¡ã—ã•ã‚“', // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    points: 0,
                    lastUpdate: serverTimestamp(),
                    lastComment: "", // åˆæœŸã‚³ãƒ¡ãƒ³ãƒˆã¯ç©º
                    lastCommentTime: serverTimestamp()
                });
                currentPoints = 0;
                currentPointsSpan.textContent = currentPoints;
            }
            // èªè¨¼å®Œäº†å¾Œã«ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            if (auth.currentUser) { // èªè¨¼æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                startChallengeTimer();
            }
        };

        /**
         * ç­‹ãƒˆãƒ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
         */
        const startChallengeTimer = () => {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (challengeTimeout) {
                clearTimeout(challengeTimeout);
            }
            // ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”ï¼ˆä¾‹: 10ç§’ã€œ60ç§’ï¼‰ã§ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç™ºç”Ÿã•ã›ã‚‹
            const minInterval = 10000; // 10ç§’
            const maxInterval = 60000; // 60ç§’
            const randomInterval = Math.random() * (maxInterval - minInterval) + minInterval;
            console.log(`æ¬¡ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¯${(randomInterval / 1000).toFixed(1)}ç§’å¾Œã«æ¥ã¾ã™ã€‚`);
            challengeTimeout = setTimeout(showChallenge, randomInterval);
        };

        /**
         * ç­‹ãƒˆãƒ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        const showChallenge = () => {
            const randomMenu = workoutMenus[Math.floor(Math.random() * workoutMenus.length)];
            challengeText.textContent = randomMenu.text;
            completeChallengeBtn.dataset.points = randomMenu.points; // ç²å¾—ãƒã‚¤ãƒ³ãƒˆã‚’ãƒœã‚¿ãƒ³ã«è¨­å®š
            challengeArea.classList.add('active'); // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«)
        };

        /**
         * ç­‹ãƒˆãƒ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†æ™‚ã®å‡¦ç†
         */
        completeChallengeBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessageBox('å…ˆã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const pointsToGet = parseInt(completeChallengeBtn.dataset.points);
            currentPoints += pointsToGet;
            currentPointsSpan.textContent = currentPoints;

            // Firestoreã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            try {
                await updateDoc(userDocRef, {
                    points: currentPoints,
                    lastUpdate: serverTimestamp()
                });
                challengeArea.classList.remove('active'); // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
                showMessageBox(`${pointsToGet}ptã‚²ãƒƒãƒˆï¼åˆè¨ˆ${currentPoints}ptï¼`, showCommentMessageBox); // ãƒã‚¤ãƒ³ãƒˆç²å¾—å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚’ä¿ƒã™
                updateRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
            } catch (error) {
                console.error("Error updating points:", error);
                showMessageBox("ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ãƒ³ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                startChallengeTimer(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¿ã‚¤ãƒãƒ¼ã¯å†é–‹
            }
        });

        /**
         * ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        const updateRanking = () => {
            if (!db) {
                console.warn("Firestore is not initialized yet. Cannot update ranking.");
                return;
            }
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersCollectionRef, orderBy('points', 'desc')); // ãƒã‚¤ãƒ³ãƒˆã®é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ

            onSnapshot(q, (snapshot) => {
                rankingList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                let rank = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'px-4', 'border-b', 'border-gray-100');
                    if (doc.id === userId) {
                        listItem.classList.add('bg-blue-50', 'font-bold', 'text-blue-700', 'rounded-md'); // è‡ªåˆ†ã®é †ä½ã‚’å¼·èª¿
                    }
                    listItem.innerHTML = `
                        <div>
                            <span>${rank}. ${data.nickname}</span>
                            ${data.lastComment ? `<p class="text-sm text-gray-500 mt-1">"${data.lastComment}"</p>` : ''}
                        </div>
                        <span class="text-green-600">${data.points}pt</span>
                    `;
                    rankingList.appendChild(listItem);
                    rank++;
                });
            }, (error) => {
                console.error("Error getting ranking: ", error);
                showMessageBox("ã‚¨ãƒ©ãƒ¼: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        window.onload = initializeFirebaseAndAuth;
    </script>
</body>
</html>
