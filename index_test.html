<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≠ã„ÉÅ„É£„É¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter„Éï„Ç©„É≥„Éà„ÅÆË™≠„ÅøËæº„Åø */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 95%;
            max-width: 550px;
            box-sizing: border-box; /* „Éë„Éá„Ç£„É≥„Ç∞„ÇíÂπÖ„Å´Âê´„ÇÅ„Çã */
        }

        h1, h2 {
            color: #4CAF50; /* Green */
            margin-bottom: 20px;
            font-weight: 700;
        }

        .user-info, .ranking-area {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #fcfcfc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        input[type="text"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-right: 10px;
            width: calc(100% - 120px);
            max-width: 250px;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .challenge-area {
            background-color: #ffe0b2; /* Light Orange */
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 3px solid #ff9800; /* Orange border */
            animation: fadeInScale 0.6s ease-out forwards; /* Appearance animation */
            display: none; /* Initially hidden */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .challenge-area.active {
            display: block; /* Show when active */
        }

        .challenge-area h2 {
            color: #d84315; /* Darker Orange */
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .challenge-area p {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            line-height: 1.5;
        }

        #completeChallengeBtn {
            background-color: #2196F3; /* Blue */
        }

        #completeChallengeBtn:hover {
            background-color: #1976D2;
        }

        #currentPoints {
            font-weight: 700;
            color: #4CAF50;
            font-size: 1.4em;
        }

        #displayUserId {
            font-weight: 600;
            color: #607D8B; /* Greyish Blue */
            word-break: break-all; /* Èï∑„ÅÑID„Åß„ÇÇÊäò„ÇäËøî„Åô */
        }

        .ranking-area ul {
            list-style: none;
            padding: 0;
            max-height: 250px; /* „É©„É≥„Ç≠„É≥„Ç∞„É™„Çπ„Éà„ÅÆÈ´ò„ÅïÂà∂Èôê */
            overflow-y: auto; /* „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å´„Åô„Çã */
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fff;
        }

        .ranking-area li {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-area li:last-child {
            border-bottom: none;
        }

        .ranking-area li span:first-child {
            font-weight: 600;
        }

        /* Message Box Styles (for general messages) */
        .message-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.active {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 90%;
            min-width: 300px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .message-box.active .message-box-content {
            transform: translateY(0);
        }

        .message-box-content p {
            margin-bottom: 25px;
            font-size: 1.2em;
            font-weight: 500;
            color: #444;
        }

        .message-box-content button {
            background-color: #607D8B; /* Greyish Blue */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-box-content button:hover {
            background-color: #546E7A;
        }

        /* Comment Box Specific Styles */
        #commentMessageBox .message-box-content {
            background-color: #e3f2fd; /* Light Blue background for comment modal */
            border: 2px solid #90caf9;
        }
        #commentMessageBox p {
            color: #1a237e; /* Darker blue text */
        }
        #commentInput {
            border: 1px solid #a7d9f7;
            background-color: #f7fcff;
            color: #333;
        }
        #postCommentBtn {
            background-color: #42a5f5; /* Blue */
        }
        #postCommentBtn:hover {
            background-color: #2196F3;
        }
        #skipCommentBtn {
            background-color: #9e9e9e; /* Grey */
        }
        #skipCommentBtn:hover {
            background-color: #757575;
        }


        /* Animations */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            input[type="text"] {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            button {
                width: 100%;
            }
            .user-info button {
                margin-top: 10px;
            }
            .message-box-content {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí™ Á≠ã„ÉÅ„É£„É¨ üí™</h1>
        <div class="user-info">
            <input type="text" id="nicknameInput" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ (10ÊñáÂ≠ó„Åæ„Åß)" maxlength="10" class="w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
            <button id="saveNicknameBtn" class="mt-2 md:mt-0 px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-all shadow-md">ÁôªÈå≤</button>
            <p class="mt-4 text-lg">„ÅÇ„Å™„Åü„ÅÆ„É¶„Éº„Ç∂„ÉºID: <span id="displayUserId" class="font-bold text-gray-700">Êú™ÁôªÈå≤</span></p>
            <p class="mt-2 text-xl">ÁèæÂú®„ÅÆÁ≠ãËÇâ„Éù„Ç§„É≥„Éà: <span id="currentPoints" class="font-bold text-green-600">0</span>pt</p>
        </div>

        <div id="challengeArea" class="challenge-area">
            <h2>üö® Á≠ã„Éà„É¨„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ üö®</h2>
            <p id="challengeText" class="text-gray-800"></p>
            <button id="completeChallengeBtn" class="mt-4 px-8 py-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-all shadow-lg">„ÇÑ„Å£„ÅüÔºÅ (Á≠ãËÇâ„Éù„Ç§„É≥„ÉàGET)</button>
        </div>

        <div class="ranking-area">
            <h2>üèÜ Á≠ãËÇâ„É©„É≥„Ç≠„É≥„Ç∞ üèÜ</h2>
            <ul id="rankingList" class="divide-y divide-gray-200">
                <!-- „É©„É≥„Ç≠„É≥„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
            </ul>
        </div>
    </div>

    <!-- General Message Box HTML -->
    <div id="messageBox" class="message-box">
        <div class="message-box-content">
            <p id="messageText"></p>
            <button id="messageBoxCloseBtn">OK</button>
        </div>
    </div>

    <!-- Comment Box HTML -->
    <div id="commentMessageBox" class="message-box">
        <div class="message-box-content">
            <p class="text-xl font-semibold mb-4">‰ªäÊó•„ÅÆÁ≠ã„Éà„É¨„ÄÅ„Å©„ÅÜ„Å†„Å£„ÅüÔºü</p>
            <textarea id="commentInput" class="w-full p-3 border rounded-lg mb-4 resize-y focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all" rows="3" placeholder="‰∏ÄË®Ä„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ (‰ªªÊÑè)"></textarea>
            <div class="flex justify-around gap-4">
                <button id="postCommentBtn" class="flex-1 px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-all shadow-md">ÊäïÁ®ø</button>
                <button id="skipCommentBtn" class="flex-1 px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all shadow-md">„Çπ„Ç≠„ÉÉ„Éó</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK„ÅÆË™≠„ÅøËæº„Åø -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Åã„ÇâFirebase„ÅÆË®≠ÂÆö„ÇíÂèñÂæó
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db, userId; // Firebase Auth, Firestore„Ç§„É≥„Çπ„Çø„É≥„Çπ, „É¶„Éº„Ç∂„ÉºID
        let currentPoints = 0; // ÁèæÂú®„ÅÆ„Éù„Ç§„É≥„Éà
        let challengeTimeout; // „ÉÅ„É£„É¨„É≥„Ç∏„Çø„Ç§„Éû„Éº„ÅÆID

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNicknameBtn = document.getElementById('saveNicknameBtn');
        const currentPointsSpan = document.getElementById('currentPoints');
        const displayUserIdSpan = document.getElementById('displayUserId');
        const challengeArea = document.getElementById('challengeArea');
        const challengeText = document.getElementById('challengeText');
        const completeChallengeBtn = document.getElementById('completeChallengeBtn');
        const rankingList = document.getElementById('rankingList');

        // „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„ÇπË¶ÅÁ¥† (Ê±éÁî®)
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        // „Ç≥„É°„É≥„Éà„Éú„ÉÉ„ÇØ„ÇπË¶ÅÁ¥†
        const commentMessageBox = document.getElementById('commentMessageBox');
        const commentInput = document.getElementById('commentInput');
        const postCommentBtn = document.getElementById('postCommentBtn');
        const skipCommentBtn = document.getElementById('skipCommentBtn');

        // Á≠ã„Éà„É¨„É°„Éã„É•„Éº„ÅÆ„É™„Çπ„Éà
        const workoutMenus = [
            { text: "„Çπ„ÇØ„ÉØ„ÉÉ„Éà5ÂõûÔºÅÁ´ã„Å£„Åü„Å§„ÅÑ„Åß„Å´„ÇÑ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ", points: 10 },
            { text: "ËÉå‰º∏„Å≥10ÁßíÔºÅÂ§©‰∫ï„Å´Êâã„ÅåÂ±ä„Åè„Åã„Å™Ôºü", points: 5 },
            { text: "ËÇ©Âõû„Åó10ÂõûÔºÅËÇ©„Åì„ÇäËß£Ê∂à„Å´„ÇÇ„Å™„Çã„ÇàÔºÅ", points: 5 },
            { text: "Ê§ÖÂ≠ê„Å´Â∫ß„Å£„Å¶Ë∂≥Ë∏è„Åø30ÁßíÔºÅÊ∞óÂàÜËª¢Êèõ„Å´ÔºÅ", points: 7 },
            { text: "ËÖïÁ´ã„Å¶‰ºè„Åõ3ÂõûÔºÅ„Åß„Åç„ÇãÁØÑÂõ≤„ÅßOKÔºÅ", points: 15 },
            { text: "„Åù„ÅÆÂ†¥„ÅßË∂≥Ë∏è„Åø1ÂàÜÔºÅË°ÄË°å‰øÉÈÄ≤ÔºÅ", points: 8 },
            { text: "„Åã„Åã„Å®‰∏ä„Åí10ÂõûÔºÅ„Åµ„Åè„Çâ„ÅØ„Åé„ÇíÈçõ„Åà„Çà„ÅÜÔºÅ", points: 6 },
            { text: "Â£Å„Çí‰Ωø„Å£„ÅüËÖïÁ´ã„Å¶‰ºè„Åõ5ÂõûÔºÅ", points: 12 }
        ];

        /**
         * „Ç´„Çπ„Çø„É†„É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
         * @param {string} message - Ë°®Á§∫„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏
         * @param {function} [onCloseCallback] - „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ„ÅåÈñâ„Åò„Çâ„Çå„ÅüÂæå„Å´ÂÆüË°å„Åô„Çã„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞
         */
        const showMessageBox = (message, onCloseCallback = null) => {
            messageText.textContent = message;
            messageBox.classList.add('active');

            // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâËøΩÂä†Ôºà‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ
            const closeHandler = () => {
                messageBox.classList.remove('active');
                messageBoxCloseBtn.removeEventListener('click', closeHandler); // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };
            messageBoxCloseBtn.addEventListener('click', closeHandler);
        };

        /**
         * „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Éú„ÉÉ„ÇØ„Çπ„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
         */
        const showCommentMessageBox = () => {
            commentInput.value = ''; // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            commentMessageBox.classList.add('active');
        };

        /**
         * „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Éú„ÉÉ„ÇØ„Çπ„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
         */
        const hideCommentMessageBox = () => {
            commentMessageBox.classList.remove('active');
        };

        // „Ç≥„É°„É≥„ÉàÊäïÁ®ø„Éú„Çø„É≥„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        postCommentBtn.addEventListener('click', async () => {
            const comment = commentInput.value.trim();
            await saveComment(comment);
            hideCommentMessageBox();
            showMessageBox("„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ", startChallengeTimer);
        });

        // „Ç≥„É°„É≥„Éà„Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        skipCommentBtn.addEventListener('click', async () => {
            await saveComment(""); // Á©∫„ÅÆ„Ç≥„É°„É≥„Éà„Çí‰øùÂ≠òÔºà„Ç≥„É°„É≥„Éà„Å™„Åó„ÇíÁ§∫„ÅôÔºâ
            hideCommentMessageBox();
            showMessageBox("„Ç≥„É°„É≥„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ", startChallengeTimer);
        });

        /**
         * „Ç≥„É°„É≥„Éà„ÇíFirestore„Å´‰øùÂ≠ò„Åô„ÇãÈñ¢Êï∞
         * @param {string} comment - ‰øùÂ≠ò„Åô„Çã„Ç≥„É°„É≥„Éà
         */
        const saveComment = async (comment) => {
            if (!userId) {
                console.error("User ID is not set. Cannot save comment.");
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            try {
                await updateDoc(userDocRef, {
                    lastComment: comment,
                    lastCommentTime: serverTimestamp() // „Ç≥„É°„É≥„ÉàÊäïÁ®øÊôÇÂàª„ÇÇË®òÈå≤
                });
                console.log("Comment saved successfully.");
            } catch (error) {
                console.error("Error saving comment:", error);
                showMessageBox("„Ç®„É©„Éº: „Ç≥„É°„É≥„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        };

        /**
         * Firebase„ÇíÂàùÊúüÂåñ„Åó„ÄÅË™çË®ºÁä∂ÊÖã„ÇíÁõ£Ë¶ñ„Åô„ÇãÈñ¢Êï∞
         */
        const initializeFirebaseAndAuth = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // „É¶„Éº„Ç∂„Éº„ÅåË™çË®ºÊ∏à„Åø„ÅÆÂ†¥Âêà
                        userId = user.uid;
                        displayUserIdSpan.textContent = userId; // UI„Å´„É¶„Éº„Ç∂„ÉºID„ÇíË°®Á§∫
                        console.log("Firebase Auth Ready. User ID:", userId);
                        await loadUserData(); // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Çí„É≠„Éº„Éâ
                        updateRanking(); // „É©„É≥„Ç≠„É≥„Ç∞„ÇíÊõ¥Êñ∞
                    } else {
                        // „É¶„Éº„Ç∂„Éº„ÅåÊú™Ë™çË®º„ÅÆÂ†¥Âêà„ÄÅ„Ç´„Çπ„Çø„É†„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„Çå„Å∞„Çµ„Ç§„É≥„Ç§„É≥„ÄÅ„Å™„Åë„Çå„Å∞ÂåøÂêç„Çµ„Ç§„É≥„Ç§„É≥
                        console.log("User is signed out or anonymous. Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (signInError) {
                            console.error("Error during sign-in:", signInError);
                            showMessageBox("„Ç®„É©„Éº: Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç¢„Éó„É™„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                            // ÂåøÂêç„É¶„Éº„Ç∂„ÉºID„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ (Ë™çË®º„ÅåÂÆåÂÖ®„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà)
                            userId = localStorage.getItem('userId') || crypto.randomUUID();
                            displayUserIdSpan.textContent = userId + " (ÂåøÂêç)";
                            await loadUserData();
                            updateRanking();
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("„Ç®„É©„Éº: „Ç¢„Éó„É™„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        };

        /**
         * „Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÅÆ‰øùÂ≠ò„Å®„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
         */
        saveNicknameBtn.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                // „Éã„ÉÉ„ÇØ„Éç„Éº„É†„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                localStorage.setItem('nickname', nickname);
                // „É¶„Éº„Ç∂„ÉºID„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅ„Åì„Åì„ÅßË®≠ÂÆöÔºàÂåøÂêç„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥ÂêàÔºâ
                if (!userId) {
                    userId = localStorage.getItem('userId') || crypto.randomUUID();
                    localStorage.setItem('userId', userId);
                    displayUserIdSpan.textContent = userId + " (ÂåøÂêç)";
                }
                await loadUserData(); // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Çí„É≠„Éº„Éâ„Åó„Å¶Ë°®Á§∫„ÇíÊõ¥Êñ∞
                startChallengeTimer(); // „ÉÅ„É£„É¨„É≥„Ç∏„Çø„Ç§„Éû„ÉºÈñãÂßã
                showMessageBox(`„Éã„ÉÉ„ÇØ„Éç„Éº„É†„Äå${nickname}„Äç„ÅßÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`);
            } else {
                showMessageBox('„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        /**
         * „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíFirestore„Åã„ÇâË™≠„ÅøËæº„Åø„ÄÅUI„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
         */
        const loadUserData = async () => {
            if (!userId) {
                console.warn("User ID is not set yet. Cannot load user data.");
                return;
            }

            const nickname = localStorage.getItem('nickname');
            if (nickname) {
                nicknameInput.value = nickname;
                saveNicknameBtn.disabled = true; // ÁôªÈå≤Ê∏à„Åø„Å™„Çâ„Éú„Çø„É≥ÁÑ°ÂäπÂåñ
                nicknameInput.disabled = true; // „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÖ•ÂäõÊ¨Ñ„ÇÇÁÑ°ÂäπÂåñ
            } else {
                // „Éã„ÉÉ„ÇØ„Éç„Éº„É†„Åå„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„Å™„Åë„Çå„Å∞„ÄÅÂÖ•ÂäõÂèØËÉΩ„Å´„Åô„Çã
                saveNicknameBtn.disabled = false;
                nicknameInput.disabled = false;
            }

            // Firestore„Åã„Çâ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíÂèñÂæó
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                currentPoints = userDoc.data().points || 0;
                currentPointsSpan.textContent = currentPoints;
                // Firestore„ÅÆ„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÑ™ÂÖàÔºàÂà•„Éá„Éê„Ç§„Çπ„Åã„Çâ„ÅÆÊõ¥Êñ∞ËÄÉÊÖÆÔºâ
                if (userDoc.data().nickname && userDoc.data().nickname !== nickname) {
                    nicknameInput.value = userDoc.data().nickname;
                    localStorage.setItem('nickname', userDoc.data().nickname);
                }
            } else {
                // Âàù„ÇÅ„Å¶„ÅÆ„É¶„Éº„Ç∂„Éº„Åß„ÅÇ„Çå„Å∞Firestore„Å´ÁôªÈå≤
                await setDoc(userDocRef, {
                    nickname: nickname || 'ÂêçÁÑ°„Åó„Åï„Çì', // „Éã„ÉÉ„ÇØ„Éç„Éº„É†„Åå„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà
                    points: 0,
                    lastUpdate: serverTimestamp(),
                    lastComment: "", // ÂàùÊúü„Ç≥„É°„É≥„Éà„ÅØÁ©∫
                    lastCommentTime: serverTimestamp()
                });
                currentPoints = 0;
                currentPointsSpan.textContent = currentPoints;
            }
            // Ë™çË®ºÂÆå‰∫ÜÂæå„Å´„Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
            if (auth.currentUser) { // Ë™çË®ºÊ∏à„Åø„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
                startChallengeTimer();
            }
        };

        /**
         * Á≠ã„Éà„É¨„ÉÅ„É£„É¨„É≥„Ç∏„Çø„Ç§„Éû„Éº„ÇíÈñãÂßã„Åô„ÇãÈñ¢Êï∞
         */
        const startChallengeTimer = () => {
            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Åå„ÅÇ„Çå„Å∞„ÇØ„É™„Ç¢
            if (challengeTimeout) {
                clearTimeout(challengeTimeout);
            }
            // „É©„É≥„ÉÄ„É†„Å™ÈñìÈöîÔºà‰æã: 10Áßí„Äú60ÁßíÔºâ„Åß„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÁô∫Áîü„Åï„Åõ„Çã
            const minInterval = 10000; // 10Áßí
            const maxInterval = 60000; // 60Áßí
            const randomInterval = Math.random() * (maxInterval - minInterval) + minInterval;
            console.log(`Ê¨°„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„ÅØ${(randomInterval / 1000).toFixed(1)}ÁßíÂæå„Å´Êù•„Åæ„Åô„ÄÇ`);
            challengeTimeout = setTimeout(showChallenge, randomInterval);
        };

        /**
         * Á≠ã„Éà„É¨„ÉÅ„É£„É¨„É≥„Ç∏„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
         */
        const showChallenge = () => {
            const randomMenu = workoutMenus[Math.floor(Math.random() * workoutMenus.length)];
            challengeText.textContent = randomMenu.text;
            completeChallengeBtn.dataset.points = randomMenu.points; // Áç≤Âæó„Éù„Ç§„É≥„Éà„Çí„Éú„Çø„É≥„Å´Ë®≠ÂÆö
            challengeArea.classList.add('active'); // „ÉÅ„É£„É¨„É≥„Ç∏„Ç®„É™„Ç¢„ÇíË°®Á§∫ („Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áô∫ÁÅ´)
        };

        /**
         * Á≠ã„Éà„É¨„ÉÅ„É£„É¨„É≥„Ç∏ÂÆå‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
         */
        completeChallengeBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessageBox('ÂÖà„Å´„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const pointsToGet = parseInt(completeChallengeBtn.dataset.points);
            currentPoints += pointsToGet;
            currentPointsSpan.textContent = currentPoints;

            // Firestore„ÅÆ„Éù„Ç§„É≥„Éà„ÇíÊõ¥Êñ∞
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            try {
                await updateDoc(userDocRef, {
                    points: currentPoints,
                    lastUpdate: serverTimestamp()
                });
                challengeArea.classList.remove('active'); // „ÉÅ„É£„É¨„É≥„Ç∏„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫
                showMessageBox(`${pointsToGet}pt„Ç≤„ÉÉ„ÉàÔºÅÂêàË®à${currentPoints}ptÔºÅ`, showCommentMessageBox); // „Éù„Ç§„É≥„ÉàÁç≤ÂæóÂæå„Å´„Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Çí‰øÉ„Åô
                updateRanking(); // „É©„É≥„Ç≠„É≥„Ç∞„ÇíÊõ¥Êñ∞
            } catch (error) {
                console.error("Error updating points:", error);
                showMessageBox("„Ç®„É©„Éº: „Éù„Ç§„É≥„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                startChallengeTimer(); // „Ç®„É©„Éº„Åß„ÇÇ„Çø„Ç§„Éû„Éº„ÅØÂÜçÈñã
            }
        });

        /**
         * „É©„É≥„Ç≠„É≥„Ç∞„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
         */
        const updateRanking = () => {
            if (!db) {
                console.warn("Firestore is not initialized yet. Cannot update ranking.");
                return;
            }
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersCollectionRef, orderBy('points', 'desc')); // „Éù„Ç§„É≥„Éà„ÅÆÈ´ò„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà

            onSnapshot(q, (snapshot) => {
                rankingList.innerHTML = ''; // „É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
                let rank = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'px-4', 'border-b', 'border-gray-100');
                    if (doc.id === userId) {
                        listItem.classList.add('bg-blue-50', 'font-bold', 'text-blue-700', 'rounded-md'); // Ëá™ÂàÜ„ÅÆÈ†Ü‰Ωç„ÇíÂº∑Ë™ø
                    }
                    listItem.innerHTML = `
                        <div>
                            <span>${rank}. ${data.nickname}</span>
                            ${data.lastComment ? `<p class="text-sm text-gray-500 mt-1">"${data.lastComment}"</p>` : ''}
                        </div>
                        <span class="text-green-600">${data.points}pt</span>
                    `;
                    rankingList.appendChild(listItem);
                    rank++;
                });
            }, (error) => {
                console.error("Error getting ranking: ", error);
                showMessageBox("„Ç®„É©„Éº: „É©„É≥„Ç≠„É≥„Ç∞„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            });
        };

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ
        window.onload = initializeFirebaseAndAuth;
    </script>
</body>
</html>
